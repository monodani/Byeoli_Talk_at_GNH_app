name: ğŸ”„ ë²¡í„°ìŠ¤í† ì–´ ìë™ ì—…ë°ì´íŠ¸

# íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  # data í´ë”ì˜ ëª¨ë“  íŒŒì¼ ë³€ê²½ ì‹œ ìë™ ì‹¤í–‰
  push:
    branches: [ operation ]
    paths:
      - 'data/**/*'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'ê°•ì œ ì¬ë¹Œë“œ ì—¬ë¶€'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

# í™˜ê²½ ë³€ìˆ˜
env:
  PYTHONPATH: ${{ github.workspace }}
  PYTHONIOENCODING: utf-8

jobs:
  update-vectorstores:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 30ë¶„ íƒ€ì„ì•„ì›ƒ
    
    permissions:
      contents: write  # ë²¡í„°ìŠ¤í† ì–´ íŒŒì¼ ì»¤ë°‹ì„ ìœ„í•´ í•„ìš”
      
    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ (í•´ì‹œ ê³„ì‚°ìš©)
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 2. Python í™˜ê²½ ì„¤ì •
      - name: ğŸ Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. ë””ë ‰í„°ë¦¬ êµ¬ì¡° í™•ì¸
      - name: ğŸ“ ë””ë ‰í„°ë¦¬ êµ¬ì¡° í™•ì¸
        run: |
          echo "=== í”„ë¡œì íŠ¸ êµ¬ì¡° ==="
          ls -la
          echo "=== data ë””ë ‰í„°ë¦¬ ==="
          find data/ -type f -name "*" | head -20 || echo "data ë””ë ‰í„°ë¦¬ ì—†ìŒ"
          echo "=== vectorstores ë””ë ‰í„°ë¦¬ ==="
          find vectorstores/ -type f -name "*" | head -10 || echo "vectorstores ë””ë ‰í„°ë¦¬ ì—†ìŒ"
          echo "=== modules ë””ë ‰í„°ë¦¬ ==="
          ls -la modules/ || echo "modules ë””ë ‰í„°ë¦¬ ì—†ìŒ"
      
      # 5. ë³€ê²½ëœ íŒŒì¼ í™•ì¸
      - name: ğŸ“„ ë³€ê²½ëœ íŒŒì¼ í™•ì¸
        run: |
          echo "=== ìµœê·¼ ì»¤ë°‹ì—ì„œ ë³€ê²½ëœ íŒŒì¼ ==="
          git diff --name-only HEAD~1 HEAD || echo "ë³€ê²½ëœ íŒŒì¼ ì—†ìŒ"
          echo "=== data í´ë” ë³€ê²½ ì‚¬í•­ ==="
          git diff --name-only HEAD~1 HEAD | grep "^data/" || echo "data í´ë” ë³€ê²½ ì—†ìŒ"
      
      # 6. ë²¡í„°ìŠ¤í† ì–´ ë¹Œë“œ ì‹¤í–‰
      - name: ğŸ”¨ ë²¡í„°ìŠ¤í† ì–´ ë¹Œë“œ ì‹¤í–‰
        env:
          OPENAI_API_KEY: ${{ secrets.OPEN_API_KEY_DEV }}
        run: |
          echo "::group::ë²¡í„°ìŠ¤í† ì–´ ë¹Œë“œ ì‹œì‘"
          echo "API í‚¤ í™•ì¸: ${OPENAI_API_KEY:0:10}..." # ë³´ì•ˆìƒ ì¼ë¶€ë§Œ ì¶œë ¥
          python scripts/build_all_vectorstores.py
          echo "::endgroup::"
      
      # 7. ë¹Œë“œ ê²°ê³¼ í™•ì¸
      - name: ğŸ“Š ë¹Œë“œ ê²°ê³¼ í™•ì¸
        run: |
          echo "=== ìƒì„±ëœ ë²¡í„°ìŠ¤í† ì–´ íŒŒì¼ ==="
          find vectorstores/ -name "*.faiss" -o -name "*.pkl" | sort
          echo "=== ë¹Œë“œ ë³´ê³ ì„œ ==="
          if [ -f "vectorstore_build_report.json" ]; then
            cat vectorstore_build_report.json | python -m json.tool
          else
            echo "ë¹Œë“œ ë³´ê³ ì„œ ì—†ìŒ"
          fi
          echo "=== ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ==="
          du -sh vectorstores/*/
      
      # 8. Git ì„¤ì • ë° ë³€ê²½ì‚¬í•­ ì»¤ë°‹
      - name: ğŸ“ ë²¡í„°ìŠ¤í† ì–´ ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        run: |
          # Git ì‚¬ìš©ì ì„¤ì •
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          # ë³€ê²½ì‚¬í•­ ì¶”ê°€
          git add vectorstores/
          git add vectorstore_build_report.json || true
          git add vectorstore_build.log || true
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if git diff --staged --quiet; then
            echo "ë²¡í„°ìŠ¤í† ì–´ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          else
            # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            COMMIT_MSG="ğŸ¤– Auto-update vectorstores - ${TIMESTAMP}"
            
            # ë³€ê²½ëœ data íŒŒì¼ ì •ë³´ ì¶”ê°€
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep "^data/" | tr '\n' ' ' || echo "manual trigger")
            if [ "$CHANGED_FILES" != "manual trigger" ]; then
              COMMIT_MSG="${COMMIT_MSG}\n\nChanged data files: ${CHANGED_FILES}"
            fi
            
            git commit -m "${COMMIT_MSG}"
            git push
            
            echo "âœ… ë²¡í„°ìŠ¤í† ì–´ ì—…ë°ì´íŠ¸ ì»¤ë°‹ ì™„ë£Œ"
          fi
      
      # 9. ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ì‹¤íŒ¨ ì‹œ ë””ë²„ê¹…ìš©)
      - name: ğŸ“ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        if: always()  # ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
        uses: actions/upload-artifact@v4
        with:
          name: vectorstore-build-artifacts
          path: |
            vectorstore_build.log
            vectorstore_build_report.json
          retention-days: 7
      
      # 10. ì‹¤íŒ¨ ì‹œ ì´ë©”ì¼ ì•Œë¦¼
      - name: ğŸ“§ ì‹¤íŒ¨ ì•Œë¦¼ ë°œì†¡
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.naver.com
          server_port: 587
          username: ${{ secrets.NAVER_EMAIL_USER }}
          password: ${{ secrets.NAVER_EMAIL_PASS }}
          subject: "âŒ [ê²½ë‚¨ì¸ì¬ê°œë°œì›] ë²¡í„°ìŠ¤í† ì–´ ë¹Œë“œ ì‹¤íŒ¨"
          to: holigosts@naver.com
          from: ${{ secrets.NAVER_EMAIL_USER }}
          body: |
            ì•ˆë…•í•˜ì„¸ìš”,
            
            ê²½ìƒë‚¨ë„ì¸ì¬ê°œë°œì› RAG ì±—ë´‡ì˜ ë²¡í„°ìŠ¤í† ì–´ ìë™ ì—…ë°ì´íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
            
            ğŸ“Š ë¹Œë“œ ì •ë³´:
            - ì‹¤í–‰ ì‹œê°„: ${{ github.run_started_at }}
            - ë¸Œëœì¹˜: ${{ github.ref_name }}
            - ì»¤ë°‹: ${{ github.sha }}
            - ì›Œí¬í”Œë¡œìš°: ${{ github.workflow }}
            
            ğŸ” ìƒì„¸ ì •ë³´:
            - GitHub Actions ë¡œê·¸: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ì—ì„œ ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            
            ğŸ’¾ ë³€ê²½ëœ ë°ì´í„° íŒŒì¼:
            ${{ steps.check-changes.outputs.changed-files || 'ìˆ˜ë™ ì‹¤í–‰' }}
            
            âš ï¸ ì¡°ì¹˜ê°€ í•„ìš”í•œ ì‚¬í•­:
            1. GitHub Actions ë¡œê·¸ì—ì„œ ì‹¤íŒ¨ ì›ì¸ í™•ì¸
            2. ë°ì´í„° íŒŒì¼ í˜•ì‹ ë° ë‚´ìš© ê²€ì¦
            3. OpenAI API í‚¤ ë° í™˜ê²½ ì„¤ì • í™•ì¸
            4. í•„ìš”ì‹œ ìˆ˜ë™ìœ¼ë¡œ ë²¡í„°ìŠ¤í† ì–´ ì¬ë¹Œë“œ
            
            ê°ì‚¬í•©ë‹ˆë‹¤.
            
            ---
            GitHub Actions ìë™ ì•Œë¦¼ ì‹œìŠ¤í…œ
